Thu Apr 28 14:01:09 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* io.c (close_one): Fix bug: when searching for files to close (because
	we are out of file descriptors), we need to limit our search to files
	that were opened for writing only.

Thu Apr 28 13:58:00 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (STREQNN): Arnold does not like the '!memcmp' style, so I
	changed it to 'memcmp == 0'.

Thu Apr 28 13:44:20 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	Patch suggested by Jean-Marc Saffroy <jean-marc.saffroy@ext.bull.net>
	on bug-gawk@gnu.org mailing list (but do not change AWKNUM type
	from double to long double at this time).
	* builtin.c (format_tree): The type for tmpval should be AWKNUM, not
	double.
	(do_strtonum): The type for 'd' should be AWKNUM, not double.

Sun Apr 24 10:03:59 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* builtin.c (tmp_integer, do_lshift, do_rshift):
	The changes I made to support 64 bit integers had some problems
	with rounding errorrs and with mantissa length. So I un-did them.
	Furthermore, Andrew suggested to change the --lint warnings.
	These warnings in do_lshift and do_rshift are now triggered when
	the shift value exceeds AWKNUM_FRACTION_BITS (previously the value
	was compared to sizeof(uintmax_t) * CHAR_BIT). 

Thu Apr 21 18:05:29 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* eval.c (r_tree_eval): Fix bug in Node_assign_concat: make sure
	concatenated string is terminated with a '\0' char.

Thu Apr 21 17:55:13 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Define new STREQNN macro for comparing two counted strings.
	* array.c (assoc_find, do_delete): Use new STREQNN macro instead
	of STREQN.  This fixes a possible bug in multi-byte encodings where
	strings could have embedded 0 bytes.
	(strhash_get, strhash_delete): Use new STREQNN macro instead of
	calling memcmp directly.

Wed Apr 20 18:23:19 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* builtin.c (tmp_integer):
	Some users want 64 bit integers (if the environment has it).
	See the newsgroup comp.lang.awk in April 2005.
	Therefore, we have commented out the two lines that strip
	leading nonzero bits of integers which would exceed AWKNUM's size.

Mon Apr 18 16:55:19 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (assoc_search): Declare new function.
	* array.c (assoc_search): New function to lookup a subscript
	in an array without creating it if it does not exist already.

Sun Apr 17 19:17:16 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (strhash_delete_func): Change arguments to callback function
	to be more sensible (e.g. it is now possible to use "free" as a
	delete callback function).
	* array.c (strhash_delete): Change arguments to delete callback
	function.  And make sure to remove the element entirely from the
	hashtable before calling the function (so table is in a consistent
	state).
	(strhash_destroy): Change arguments to delete callback function, and
	do some optimization.  Make sure the table is in a consistent state
	when the callback function is called.

Sat Apr 16 16:24:52 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (unset_ERRNO): Declare new function.
	* eval.c (unset_ERRNO): New function to set ERRNO to "".
	* io.c (do_close): Use new set_ERRNO function instead of setting
	ERRNO_node manually.  Also, remove declaration of ERRNO_node, since
	we now change it using only the helper functions.

Fri Apr 15 16:48:04 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* ext.c (load_run): In fatal messages, do not include "\n".

Fri Apr 15 16:13:52 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* array.c (strhash_create, strhash_grow): Must call memset after
	emalloc.  Unfortunately, awk.h does not define an ecalloc macro.

Fri Apr 15 12:48:22 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: Add a --disable-pgsql option for those who do
	not want to build the pgsql extension.  And remove AC_DEFINE(BUILD_XML),
	since the source code no longer checks this #ifdef (everything is done
	using the automake conditional now).  Also, change the configure
	help message to say --disable-xml instead of --enable-xml, since
	users are more likely to want to alter default behavior by saying
	--disable-xml.

Thu Apr 14 19:41:26 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: Added new --with-libpq argument.  Set automake
	conditional BUILD_PGSQL based on whether <libpq-fe.h> is found.

Thu Apr 14 18:49:20 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Declare new strhash API in array.c.  And declare new
	set_ERRNO and set_ERRNO_no_gettext functions in eval.c.
	Also declare dlload if DYNAMIC is defined.
	* eval.c (set_ERRNO, set_ERRNO_no_gettext): New functions to make
	it easier for code to manipulate the ERRNO string.
	* array.c (get_table_size): New function to calculate appropriate hash
	table size.
	(grow_table): Call new get_table_size function.
	(strhash_create, strhash_grow, strhash_get, strhash_delete,
	 strhash_destroy): New functions to implement generic string hash API.
	* awkgram.y (register_deferred_variable): Use new strhash API instead
	of managing our own linked list.
	(variable): Deferred variables are now stored in a strhash table.
	* io.c (path_save): Use new strhash API instead of managing our
	own hashtable.

Sat Apr  9 17:36:12 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* configure.ac: Modified Andrew's CONFDATE so that the timestamp
	is ISO-date-compliant.

Sat Apr  9 00:33:38 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* version.in: Change version string to start with "Extensible" to make
	it clear that this is not the same as FSF gawk.
	* main.c (version): Change the version wording a little bit.

Sat Apr  9 00:00:39 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* .cvsignore: Ignore version.c (file generated from version.in).

Fri Apr  8 23:55:32 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: Set CONFDATE to `date '+%Y%m%d'` for use in version.
	* version.in: Include CONFDATE in version_string.
	* main.c: Remove compilation date from version (the CONFDATE is now
	included in the version_string).
	* Makefile.am: Patch distdir to include $(CONFDATE).

Fri Apr  8 23:35:33 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* version.c: Removed.  This file is created from version.in by the
	configure script.
	* Makefile.am: Removed version.in from base_sources.  It is included
	in DIST_COMMON automatically.

Fri Apr  8 23:26:30 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c (version): Change to handle DYNAMIC and BUILD_STATIC_EXTENSIONS
	separately.

Fri Apr  8 21:34:33 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* main.c (version): Chnaged the --version screen again.
	Now the orthogonal features DYNAMIC (depending on the presence
	of the file dlfcn.h) and BUILD_STATIC_EXTENSIONS (passed as
	option --enable-static-extensions to the configure script)
	are both distinguished and reported.

Fri Apr  8 20:40:39 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* main.c (version): Changed the --version screen. It distinguishes
	between static and dynamic extensions now.

Fri Apr  8 14:39:43 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: If a program name transform is in effect (e.g. if
	configure --program-prefix=xml is being used), then do not install
	symbolic links for awk and igawk, and also omit hard links for 
	gawk-$(VERSION) and pgawk-$(VERSION).

Thu Apr  7 21:15:33 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Clean up EXTRA_DIST: do not include directories, instead
	include specific files.  That way we avoid including CVS subdirectories.
	Do not include awklib/xml in EXTRA_DIST, since this should be handled
	in awklib/Makefile.am.  Also remove extension from EXTRA_DIST, since
	extension is now included in SUBDIRS.  But do include XMLChangeLog
	in EXTRA_DIST.  In SUBDIRS, we must build "." before "awklib", since
	awklib now uses the compiled gawk binary to create the awklib/eg tree.
	Remove obsolete dist-hook (now handled by extension/Makefile.am).

Thu Apr  7 21:11:27 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* .cvsignore: Ignore *gawk-*.tar.gz and *gawk-*.tar.bz2 (results of
	make dist).

Thu Apr  7 14:48:32 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Fix bug in "make clean" when configured
	with --enable-static-extensions.

Wed Apr  6 20:52:09 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Change order of LDADD to try to fix Cygwin linking
	problems.

Mi Apr  6 17:02:29 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.am (distdir): We use an 'x' as prefix for package name.
	* Makefile.am (awklib/xml): We include this directory into the distribution.

Tue Apr  5 03:07:22 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Clean up the support for static extensions by moving all
	the logic into extension/Makefile.am.  Build source code files
	ext.init and ext.decl automatically, and make sure to clean them.
	* .cvsignore: Ignore generated files ext.decl and ext.init.
	* ext.c: Do not list all the extensions.  Instead, include ext.decl
	and ext.init which are created automatically by the Makefiles.

Mon Apr  4 21:00:38 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: New option --enable-static-extensions controls whether
	extension libraries are statically linked into the main gawk binary.
	Changed --enable-xml to simply control whether xml is built
	(default is to build if expat.h is found).  And added a
	--with-expat=PATH option to help find expat if it is not in the
	default location.
	* Makefile.am: If BUILD_STATIC_EXTENSIONS is defined, then link
	statically with all the extension libraries (including XML if BUILD_XML
	is defined).
	* awk.h, main.c: Remove #ifdef BUILD_XMLGAWK code.
	* ext.c: If BUILD_STATIC_EXTENSIONS is defined, then support statically
	linked extension libraries.

Mon Apr  4 16:05:59 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awklib/.cvsignore: Add eg and stamp-eg.
	* awklib/stamp-eg: Remove this file from CVS, since it is created
	by the Makefile.

Mon Apr  4 16:05:59 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awklib/eg: Remove this whole tree, since it is automatically
	generated from examples in the documentation .texi files.
	* awklib/Makefile.am: Restore original rule for stamp-eg that
	removes the whole eg directory tree.

Sun Apr  3 17:11:11 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.am:
	* awklib/Makefile.am:
	The files awklib/eg/lib/pwcat.c and awklib/eg/lib/grcat.c are
	generated files and they are needed for compilation. Therefore,
	awklib must be made before the root directory. Also, the targets
	pwcat and grcat in awklib/Makefile.am depend on the target
	stamp-eg because of creation of generated files.

Sun Apr  3 15:34:21 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* awklib/eg/data: Removed all files generated from gawk.texi.
	* awklib/eg/lib:  Removed all files generated from gawk.texi.
	* awklib/eg/misc: Removed all files generated from gawk.texi.
	* awklib/xml:     This new directory contains the libraries
	for the XML extension.

Sun Apr  3 15:15:31 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* awklib/Makefile.am(stamp-eg): The removal of directory eg during
	the build process was not a good idea. Especially when working
	with CVS. As a temporary solution, I replaced the command line doing
	this with another one.

	* awklib/eg/prog: Removed all files generated from gawk.texi.
	* awklib/eg/network: Removed all files generated from gawkinet.texi.

Fri Apr  1 15:40:25 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Need to uninstall igawk also.

Fri Apr  1 14:57:18 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: Change description of --enable-xml option to reflect
	that it just controls whether the XML extension is statically linked or
	dynamically loaded.  Would it be better to change the option name
	to --enable-staticxml?

Fri Apr  1 14:22:59 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: make install now creates a symbolic link from igawk
	to gawk.

Thu Mar 31 16:47:17 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Fix it to work properly when configured with --enable-xml
	and xml support is compiled in statically.  The trick is to cd
	into the extension subdirectory and build the static libxml there.
	Then we can just link the static library into the gawk binary.
	* configure.ac: Added AC_SUBST(libext) so Makefile.am knows what
	extension to use for static libraries.
	* configure, configh.in: Removed.  These files are generated
	automatically by autotools.
	* .cvsignore: Added configure and configh.in.

Wed Mar 30 16:02:52 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.in, awklib/Makefile.in, doc/Makefile.in,
	extension/Makefile.in, test/Makefile.in: Remove files that should
	be generated from Makefile.am.
	* .cvsignore, awklib/.cvsignore, doc/.cvsignore, extension/.cvsignore,
	test/.cvsignore: Add Makefile.in.

Tue Mar 29 18:59:27 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.am (extension): Changed the order of building.
	Now, extensions are built before the tests, so that extension
	can be tested. Inserted compilation of character encodings that
	Expat does not know.

Mon Mar 28 21:32:57 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_puller.[ch], xml_interface.c: Moved to extension subdirectory.

Mon Mar 28 20:37:26 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: If BUILD_XMLGAWK is enabled, compile xml code
	from the extension subdirectory.

Mon Mar 28 19:05:18 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (path_open_func): Obsolete function removed.
	(path_find): New function to replace path_open_func while keeping
	track of which files have already been loaded.
	* io.c (path_open_func): Removed.
	(path_save): New function to store loaded files in a hash table.
	(path_find): Find the file to be loaded, and return information
	indicating whether it was already loaded.
	(do_open): Remove obsolete function.
	(pathopen): Call path_find instead of path_open_func.  If do_lint
	is on, issue a warning message if the file was already loaded.
	* ext.c (do_dlopen): Remove obsolete function.
	(load_run): Call path_find instead of path_open_func.  If do_lint
	is on, issue a warning message if the file was already loaded.
	(load_extension): Add a warning message if do_lint is on.
	* awkgram.y (get_src_buf): If file was already loaded, just skip
	to the next source.
	* main.c (main): Fix error message to reflect change from '-e' to '-l'.

Mon Mar 28 18:14:50 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/XMLChangeLog: We need a separate XMLChangeLog for the
	extension directory.

Mon Mar 28 17:44:40 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Rename libdl to libzaxxon to avoid confusion
	with system library libdl.  Do not install test libraries.
	* extension/dl.c: Remove (renamed to zaxxon.c).
	* extension/zaxxon.c: Add (renamed from dl.c).

Mon Mar 28 03:42:38 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Oops, should really use INSTALL_PROGRAM,
	that way "make install-strip" will work.  Add message showing
	where each library is being installed.

Mon Mar 28 03:27:55 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Use $(INSTALL) instead of $(install_sh) -c.
	
Mon Mar 28 02:01:40 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Add hooks to choose which libraries to
	install.  For now, install them all.

Mon Mar 28 01:53:35 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Use a custom install rule to install only
	the shared libraries with the names that we want.  I'm not sure
	whether this is 100% portable...

Sun Mar 27 20:52:13 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* extension/Makefile.am: Now all extensions are compiled to shared libs.

Sun Mar 27 20:23:07 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* extension/Makefile.am: Fix installation directory, and remove -lexpat
	dependency.

Sun Mar 27 18:49:17 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>
	
	* update-autotools: New script to simulate autoreconf -i.

Sun Mar 27 17:02:14 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>
	
	* extension/Makefile: Removed.  Now using automake/libtool.

Sun Mar 27 17:02:14 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* configure.ac: Add AC_SUBST(shlibext) and AC_PROG_LIBTOOL, and
	build extension/Makefile.
	* Makefile.am: Add extension to SUBDIRS, and define SHLIBEXT.
	* extension/Makefile.am: First pass at libtool Makefile.am.

Sun Mar 27 16:59:44 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* .cvsignore: Add some libtool stuff.
	* extension/.cvsignore: New file.

Sun Mar 27 16:13:52 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (path_open_func): New function for searching a path for a file
	and trying a possible default suffix.
	* io.c (do_pathopen): Remove obsolete function.
	(path_open_func): New more general function to search a path for a
	file and try with a default suffix.
	(pathopen): Use path_open_func instead of obsolete do_pathopen.
	(do_open): New helper function for use with path_open_func.
	* ext.c (do_dlopen): New helper function for use with path_open_func.
	(path_dlopen): Remove obsolete function, use path_open_func instead.
	(load_run): Use new function path_open_func instead of path_dlopen.

Sat Mar 26 16:09:11 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awkgram.y: Introduce input_state structure to contain lexer input
	state; this allows us to push include file state on top of underlying
	state.  Define old static variables as fields of the current
	input_state structure at the top of the stack.
	(get_src_buf): Modify behavior to support include files.
	(push_include_file): New function to push an include file on top
	of the input stack used by get_src_buf.
	(yylex): Implement support for @include by calling push_include_file.

Fri Mar 25 19:27:07 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c (main): Load shared libraries using -l (--load) instead
	of -e (--extension).
	(usage): Change usage message appropriately.

Fri Mar 25 18:49:04 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awkgram.y (yylex): Implement @load directive to load a shared library.
	Also start to support @include.

Thu Mar 24 21:21:41 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c (main): If -e or -i is used with --traditional or in posix
	mode, it should be a fatal error.

Thu Mar 24 14:11:57 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c: I was calling xml_extension_init in the wrong place.
	It is now safely inside init_vars where it belongs.

Wed Mar 23 22:57:07 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.in (extensiondir DEFLIBPATH): Andrew introduced new
	variables for the implementation of a search path for extensions
	in shared libraries.

Wed Mar 23 21:27:41 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Define DEFLIBPATH as @libdir@/awk/@VERSION@
	* awk.h: Declare new global variable deflibpath and new function
	in ext.c load_extension to load extensions specified on command line.
	* main.c (main): Add new gawk options: -e to load extensions, and -i to
	include source files (same as -f, except it still allows the last
	command-line argument to contain awk program code).
	(load_environ): Supply default value for AWKLIBPATH.
	* ext.c (path_dlopen): New function to use AWKLIBPATH to find
	dynamically loaded library code.
	(load_run): New function to load a library and call a given
	initialization in the library.
	(do_ext): Use load_run to load the library and call the function.
	(load_extension): New function used to process command-line -e
	arguments.  This uses load_run to load the library and run the dlload
	function.
	* posix/gawkmisc.c (deflibpath): New global variable set to the
	value of DEFLIBPATH as defined in the Makefile.
	* unsupported/tandem/tmisc.c (deflibpath): New global variable set to
	an empty string.

Wed Mar 23 16:24:31 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_interface.c (xml_load_vars): Fix initialization bug (XMLMODE
	should not be set to Nnull_string).  Also, when loaded as an extension,
	the default value of XMLMODE should be non-zero.  For now, I am setting
	it to -1, but we may later decide that 1 is more appropriate.
	Also, if BUILD_XMLGAWK is not defined, it should be safe to assume
	that xml_interface.c is being compiled as part of a shared library
	extension.

Wed Mar 23 13:38:46 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	With these patches, the implementation of the --enable-xml
	configuration option should be complete and working.
	A special "thank you" to Mike Frysinger for pointing me to
	the use of the autoheader tool and supplying his autogen.sh.

	* Makefile.am (xml_puller.h xml_puller.c xml_interface.c): These files
	are now compiled only when BUILD_XMLGAWK is set.
	* Makefile.in (xml_puller.h xml_puller.c xml_interface.c): This file
	is generated, don't touch it.
	* aclocal.m4: This file is generated, don't touch it.
	* awk.h (BUILD_XMLGAWK): Removed the manually inserted macro
	BUILD_XMLGAWK because we have a proper solution now.
	* configh.in: This file is generated, don't touch it.
	* configure:  This file is generated, don't touch it.
	* configure.ac: Now that autoheader works correctly,
	macros AC_CHECK_HEADER and AC_MSG_ERROR can be used.
	Thanks to Mike for this patch.
	* awklib/Makefile.in: This file is generated, don't touch it.
	* doc/Makefile.in: This file is generated, don't touch it.
	* test/Makefile.in: This file is generated, don't touch it.

Tue Mar 22 19:02:15 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Eliminate all XML-specific stuff and replace with abstract,
	general hooks for installing an input processor.  So struct xml
	is removed from IOBUF and replaced with 3 pointers: void *opaque,
	int (*get_record), and void (*close_func).
	(register_deferred_variable): Declare function to register variables
	like "ENVIRON" and "PROCINFO" and "XMLMODE" that are created only
	after they are encountered by the parser.
	(register_open_hook): Allows calling code to set a function to be called
	every time a new input source is opened.  This function can then decide
	whether a file should be opened as an XML structured file or as
	a plain text file.
	(load_environ, load_procinfo): Remove prototypes: these functions are
	now static to main.c since the new register_deferred_variable API is
	being used.
	* awkgram.y (register_deferred_variable): New function to register
	variables that should be created only after they are encountered
	by the parser.
	(variable): Update logic to use new deferred variable mechanism
	instead of hard-coding PROCINFO, ENVIRON, and XMLMODE.
	* main.c (load_environ, load_procinfo): These functions are now static.
	(main): #ifdef BUILD_XMLGAWK, call xml_extension_init().
	(init_vars): Call register_deferred_variable for PROCINFO and ENVIRON.
	* io.c (iop_close): Remove XML-specific code and instead just call
	iop->close_func if it's not NULL.
	(register_open_hook): New function to set a function to be called
	every time a new file is opened.
	(iop_alloc): Remove XML-specific code and instead call any registered
	open hook functions.
	(get_a_record): Remove XML-specific code and instead just call
	iop->get_record if it's not NULL.
	* xml_interface.c: Must include xml_puller.h, since it is no longer
	included by awk.h.  Declare struct xml_state.  XMLMODE_node is no
	longer global.
	(xml_extension_init): New function to use when XML compiled into gawk.
	(dlload): New function called when loading as a dynamic module.
	(xml_load_vars): Call register_open_hook(xml_iop_open).  Do not assume
	that XMLMODE does not exist, since it could if dynamic loading is
	being used.
	(xml_iop_open): Must malloc struct xml_state and set IOBUF methods.
	(xml_iop_close): Must free struct xml_state.

Mon Mar 21 17:11:45 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	This is the first step to a configurable XML build process.
	I followed Mike Frysinger's hints and inserted an argument --enable-xml
	for the "configure" script. Just like Mike, I ran into problems
	with the automake tool in the midst of all this. Therefore, the
	macro BUILD_XMLGAWK is not yet passed properly from "configure"
	to the Makefile. To keep things compiling, I have inserted a
	#define into awk.h and hope to fix this real soon.
	* Makefile.am (LDADD): New argument @XMLGAWK_LIBS@ passes -lexpat
	* Makefile.in (@XMLGAWK_LIBS@, DEPDIR): New argument @XMLGAWK_LIBS@
	passes -lexpat now. In a lucky moment, my autoconf 1.9 produced a
	sensible way of handling DEPDIR.
	* awk.h (BUILD_XMLGAWK): Defined a macro to keep things going.
	* configure (--enable-xml): This option is switched off by default.

Mon Mar 21 14:03:05 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Put `#ifdef BUILD_XMLGAWK' around all XML-related code.
	* awkgram.y (variable): Add `#ifdef BUILD_XMLGAWK'.
	* io.c (iop_close, iop_alloc, get_a_record): Add `#ifdef BUILD_XMLGAWK'.
	* main.c (version):  Add `#ifdef BUILD_XMLGAWK'.

Mon Mar 21 13:42:09 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (NODETYPE): Remove Node_XMLMODE (we do not need a special type).
	(XMLMODE): Remove global variable (no longer used).
	(set_XMLMODE): Remove obsolete function.
	* awkgram.y (isnoeffect, isassignable) Remove case for Node_XMLMODE.
	* eval.c (nodetypes, r_tree_eval, r_get_lhs) Remove Node_XMLMODE.
	* profile.c (tree_eval, pp_lhs, is_scalar, prec_level): Remove
	Node_XMLMODE.
	* io.c (iop_alloc): XMLMODE has been removed.  Instead, just call
	xml_iop_open if XMLMODE_node is non-NULL, and let xml_iop_open decide
	whether XML is in use.
	* xml_interface.c (xml_load_vars): Change type of XMLMODE from
	Node_XMLMODE to Node_var.
	(set_XMLMODE): Remove obsolete function.
	(xml_iop_open): Decide whether to use XML parsing by testing
	value of force_number(XMLMODE_node->var_value).

Sun Mar 20 22:09:05 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.am (AM_MAKEFLAGS, LDADD): Moved -lexpat to a more
	appropriate place from AM_MAKEFLAGS to LDADD.
	Inserted @SOCKET_LIBS@ into LDADD again because at least Solaris
	really needs it (says Andrew).
	* Makefile.in (AM_MAKEFLAGS, LDADD): The same changes as above.
	The problem with -liconv (for Cygwin) remains unsolved.

Sun Mar 20 20:58:54 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Fix XML function prototypes to use P.  Declare new function
	xml_load_vars and remove obsolete xml_init_vars.
	* awkgram.y (variable): If XMLMODE is referenced and undefined,
	call xml_load_vars.
	* main.c (init_vars): Remove call to xml_init_vars, since the variables
	are now created only after XMLMODE is encountered by the parser.
	* xml_interface.c (varinit): Add XMLCHARSET to array, since it is
	initialized the same way as the other variables.
	(xml_init_vars): Removed obsolete function.
	(xml_load_vars): New function called when XMLMODE is encountered
	by the parser.  It creates all the XML-related variables.
	(resetXMLvars): Add #ifdef'ed out code to reset variables using
	an array of pointers to XML scalar variables.  The #ifdef'ed code
	is more elegant, but it turns out to be slower than the existing
	(ugly) approach.

Sun Mar 20 16:44:28 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	* Makefile.in: Manually added some lines about dependencies.
	Now, the build process is OK again and all test cases also.

Sat Mar 19 23:31:47 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* Makefile.am: Added -lexpat in an inappropriate place
	and kicked out @SOCKET_LIBS@ because it produced error
	messages with my automake-1.9.1-4.
	* Makefile.in: This is the file generated from Makefile.am.
	The problem with -liconv (for Cygwin) remains unsolved.
	Test case strtod now fails.

Sat Mar 19 18:36:46 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* Makefile.am: Add xml_interface.c to base_sources.
	* xml_interface.c: New file containing the interface between gawk
	and the XML puller parser.
	* awk.h: Remove declarations for most XML variables, since they are
	now local to xml_interface.c (except for XMLMODE_node).
	Declare new functions provided by xml_interface.c: xml_init_vars,
	xml_iop_open, xml_iop_close, and xml_get_record.
	* eval.c (set_XMLMODE): Function moved to xml_interface.c.
	* io.c (iop_close): To free XML resources, just call xml_iop_close.
	(resetXMLvars, update_xmlattr, get_xml_string, set_xml_attr,
	 get_xml_record): Functions moved to xml_interface.c
	(iop_alloc): Call xml_iop_open to set up XML parser.
	* main.c: Remove all XML variable declarations (now in xml_interface.c).
	(init_vars): Call xml_init_vars to create XML variables.

Thu Mar 17 23:23:42 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* eval.c (set_BINMODE, set_XMLMODE): Fix spelling of "arbitrary".

Thu Mar 17 23:21:17 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awkgram.y (isnoeffect): Add Node_XMLMODE to list.
	(isassignable): Add Node_XMLMODE to list.

Wed Mar 16 22:08:45 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_puller.c (XML_PullerIconv): Calculate the maximum length of the
	converted string using MB_LEN_MAX (defined in <limits.h>) instead
	of the constant "4".

Wed Mar 16 19:21:25 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c (init_vars): Install XMLATTR array variable.
	(main): Initialization of XMLATTR belongs in init_vars, not in main.

Wed Mar 16 18:02:08 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* main.c (main): Install XMLATTR variable before processing the
	command-line preassignments (using -v).  Previously, any value provided
	for XMLATTR on the command-line was being silently ignored.  Now, it
	will give an error.

Tue Mar 15 21:24:25 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Declare new global variable NODE *XMLNAME_node.
	* main.c (varinit): Add entry for XMLNAME_node.
	* io.c (resetXMLvars): Must reset new variable XMLNAME.
	(set_xml_attr): New function to insert an entry into the XMLATTR array.
	(get_xml_record): Add SET_NAME macro to use dupnode to set XMLNAME.
	Insert calls to SET_NAME and set_xml_attr to reflect event information
	appropriately.

Tue Mar 15 18:43:34 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Change struct iobuf xml.space from char[4] to char *.
	Add xml.string_cache[] array to save XMLEVENT string values.
	* io.c (xml_event_init): Remove function and all xml_event_* global
	variables, since the strings must be cached on a per-puller basis
	to make sure they have the correct encoding.
	(iop_close): Must free iop->xml.space and iop->xml.string_cache[*].
	(convert_xmlcharset_space): Remove obsolete function (use new
	XML_PullerIconv function instead).
	(iop_alloc): Call XML_PullerIconv to calculate iop->xml.space.
	Do not call xml_event_init, this is now handled differently.
	(get_xml_string): New function to generate encoded XMLEVENT strings.
	(get_xml_record): Change SET_EVENT macro to check the appropriate slot
	in iop->xml.string_cache[].

Tue Mar 15 17:32:48 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_puller.h (XML_PullerIconv): Declare new function used to convert
	string encoding.
	* xml_puller.c (XML_PullerIconv): Rename XML_PullerAllocateAndCheck to
	XML_PullerIconv and make it public so that it can be called from gawk.

Mon Mar 14 22:04:27 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>

	* doc/XMLChangeLog: Added a separate ChangeLog for the doc of
	the XML extension.
	* test/XMLChangeLog: Added a separate ChangeLog for the
	regression tests of the XML extension.

Mon Mar 14 17:20:21 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h (update_ERRNO_saved): Declare new function that allows the
	caller to specify the errno value used for the error string.
	* eval.c (update_ERRNO_saved): New function to use saved errno value
	instead of the current value.
	(update_ERRNO): Implement by calling update_ERRNO_saved.
	* io.c (close_redir): Save errno value and call update_ERRNO_saved
	instead of update_ERRNO.
	(do_getline): Call update_ERRNO_saved instead of update_ERRNO.
	But do not call update_ERRNO if get_a_record returns with errcode
	set to -1.
	(get_xml_record): If the XML parser indicated an error, and the
	errcode pointer is non-NULL, set errcode to -1 so that getline
	will return -1.

Mon Mar 14 16:25:31 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* io.c (get_xml_record): Set ERRNO to have same value as XMLERROR.

Sun Mar 13 21:19:14 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_puller.h: Add new error_len field XML_Puller structure (since
	error string is now encoded and counted).
	* xml_puller.c: Improve internal_error() messages throughout.
	(XML_PullerSetError): Add a standard prefix for expat errors ["Expat
	XML Parser error:"].  Check that expat error string is non-NULL.
	Call XML_PullerAllocateAndCheck to convert the error message to the
	proper encoding.
	(internal_error): Call XML_PullerAllocateAndCheck to convert the error
	message to the proper encoding.
	(XML_PullerFree): Must free puller->error (now that it is allocated).
	* io.c (get_xml_record): Make sure puller error string is not NULL.
	The error string is now encoded and counted and malloced, so just
	steal it (instead of copying).

Sun Mar 13 19:43:40 UTC 2005 Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Remove NODETYPE Node_XMLCHARSET.  And remove declaration
	of set_XMLCHARSET.
	* eval.c (nodetypes): Remove Node_XMLCHARSET.
	(r_tree_eval, r_get_lhs) Remove case for Node_XMLCHARSET.
	(set_XMLCHARSET) Remove empty (unused) function.
	* main.c (varinit): Change type of XMLCHARSET_node from Node_XMLCHARSET
	to Node_var.
	* profile.c (tree_eval, pp_lhs, is_scalar, prec_level) Remove case
	for Node_XMLCHARSET.

Sun Mar 13 14:47:57 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	* doc/xmlgawk.texi: Inserted menu items for each chapter
	to stop makeinfo from whining.

Sat Mar 12 23:05:35 UTC 2005  Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awkgram.y (variable): Remove special check for XMLATTR since
	it is created immediately at program startup (not on a delayed
	basis like PROCINFO and ENVIRON).

Sa Mar 12 21:47:01 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	* doc/.cvsignore Now all .info, .html, .ps and .dvi files are
	ignored (not only those generated from xmlgawk).

Sa Mar 12 21:38:02 UTC 2005 Juergen Kahrs <jkahrs@users.sourceforge.net>
	* doc/Makefile.am, doc/Makefile.in
	* With these files checked in, it is now possible to produce
        xmlgawk.ps and xmlgawk.html. The whole process is not quite
	clean yet. make html fails at first sight, but the file is
	created and usable. After a fresh cvs co of xmlgawk, the first
	make in the top directory will fail for some reason in the doc
	directory. Furthermore, gawk.texi has some problems. But all
	this sounds worse than it is because everything is produced
	correctly anyay.

Sat Mar 12 20:58:52 UTC 2005  Juergen Kahrs <jkahrs@users.sourceforge.net>
	* doc/fdl.texi The file doc/fdl.texi is included by doc/xmlgawk.texi.
	* doc/awk_proc.eps doc/docbook_chapter.eps doc/rss_inq.eps
	doc/soap_error.eps doc/soap_reply.eps doc/soap_request.eps
	are new files used by doc/xmlgawk.texi.
	* doc/xmlgawk.texi The .eps files have been checked in under
	slightly different names.

Sat Mar 12 20:36:54 UTC 2005  Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* xml_puller.c (XML_PullerNext): If read returns -1, we should set
	puller status to XML_STATUS_ERROR to indicate that there was an I/O
	error.

Sat Mar 12 20:23:26 UTC 2005  Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* awk.h: Declare XMLEVENT_node.
	* main.c: New global variable XMLEVENT_node.
	(varinit) Added entry for XMLEVENT.
	* io.c: Add static xml_event_* variables to cache XMLEVENT values.
	(resetXMLvars): Must reset new XMLEVENT variable.
	(iop_alloc): If opening an XML file, check whether xml_event_* variables
	have been initialized yet; if not, call xml_event_init.
	(xml_event_init): New function to initialize xml_event_* variables.
	(get_xml_record): For each kind of token returned by XML_PullerNext,
	set an appropriate value for XMLEVENT.

Sat Mar 12 18:37:14 UTC 2005  Andrew J. Schorr <ajschorr@users.sourceforge.net>

	* .cvsignore: Ignore changes in awkgram.c.
	* doc/.cvsignore: Ignore various files produced from the texinfo
	  source documentation.

Wed Mar  9 20:07:35 UTC 2005  Juergen Kahrs <jkahrs@users.sourceforge.net>
	* doc/xmlgawk.texi: Initial checkin. PostScript file
          and Makefile changes will follow later.

Wed Mar  9 20:24:04 UTC 2005  Juergen Kahrs <jkahrs@users.sourceforge.net>
	This source tree is based on the original distribution
        ftp://ftp.gnu.org/gnu/gawk/gawk-3.1.4.tar.gz.
	Then my patch patch_3.1.4__xml_20050305 was applied.
        Then Andrew's patch dated 2005-03-07 was applied.
        * awklib/xmllib.awk: Moved this from root to here before CVS import.
        * awklib/xmltree.awk: Moved this from root to here before CVS import.

Wed Mar  9 20:12:32 UTC 2005  Juergen Kahrs <jkahrs@users.sourceforge.net> 

        * ChangeLog created.
